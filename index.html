<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etra for CITIZEN </title>


  <link 
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" 
    rel="stylesheet"
  />


  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />


  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <script 
    defer
    src="https://cdn.jsdelivr.net/npm/sweetalert2@11"
  ></script>


  <script
    defer
    src="https://cdn.jsdelivr.net/npm/chart.js"
  ></script>

  <style>
 
  html, body {
    margin: 0; 
    padding: 0;
    overflow: hidden; /* no global scroll */
    font-family: 'Roboto', sans-serif;
    background-color: #f4f5f7;
  }
  body {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: linear-gradient(to right, #232526, #414345);
    color: #fff;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .header-left .navbar-brand {
    font-weight: bold;
    font-size: 1.3rem;
  }
  .header-right .nav-link {
    color: #ccc;
    margin-left: 18px;
    text-decoration: none;
  }
  .header-right .nav-link.active {
    color: #fff;
    font-weight: bold;
  }
  .header-right .nav-link:hover {
    color: #fff;
    text-decoration: none;
  }

  .content-wrapper {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .content-inner {
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
    width: 100%;
    height: 100%;
  }

  footer {
    background: #e9ecef;
    color: #333;
    text-align: center;
    padding: 10px 20px;
    flex-shrink: 0;
    font-size: 0.9rem;
  }


  .insights-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }
  @media (max-width: 768px) {
    .insights-container {
      grid-template-columns: 1fr;
    }
  }
  .insight-card {
    position: relative;
    height: 180px;
    border-radius: 10px;
    color: #fff;
    overflow: hidden;
    padding: 16px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.4s ease-in-out;
    cursor: pointer;
  }
  .insight-card:hover {
    transform: scale(1.02);
  }
  .insight-title {
    font-size: 18px;
    font-weight: 600;
  }
  .insight-value {
    font-size: 28px;
    font-weight: 700;
  }
  .gradient1 { background: linear-gradient(to right, #36D1DC, #5B86E5); }
  .gradient2 { background: linear-gradient(to right, #C02425, #F0CB35); }
  .gradient3 { background: linear-gradient(to right, #00B09B, #96C93D); }
  .gradient4 { background: linear-gradient(to right, #f953c6, #b91d73); }


  .charts-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-top: 30px;
  }
  @media (max-width: 768px) {
    .charts-section {
      grid-template-columns: 1fr;
    }
  }
  .chart-card {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    height: 320px;
    position: relative;
  }
  .chart-card .chart-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
  }
  #cardTypeChart, 
  #statusChart {
    width: 100% !important;
    height: 220px !important;
  }
  .chart-placeholder {
    text-align: center;
    margin-top: 30px;
    color: #999;
    font-style: italic;
  }


  #toastContainer {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 9999;
  }


  ::-webkit-scrollbar {
    width: 6px;
  }
  ::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }
  ::-webkit-scrollbar-track {
    background: #eee;
  }


  .table-container {
    max-height: 280px;
    overflow-y: auto;
  }


  .profile-card {
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 20px;
  }
  .profile-card-header {
    background: linear-gradient(to right, #232526, #414345);
    color: #fff;
    padding: 15px;
    border-radius: 8px 8px 0 0;
    margin: -20px -20px 20px -20px;
  }
  .profile-card-header h5 {
    margin: 0;
  }

   *************************************************************/
  </style>
</head>

<body>
  
  <header>
    <div class="header-left d-flex align-items-center">
      <a class="navbar-brand text-white" href="#">
        <i class="fas fa-bus me-2"></i>Etra CITIZEN
      </a>
    </div>
    <div class="header-right d-flex align-items-center">
      <a class="nav-link active" href="#home" onclick="switchTab('home')">
        <i class="fas fa-home"></i> Home
      </a>
      <a class="nav-link" href="#registration" onclick="switchTab('registration')">
        <i class="fas fa-user-plus"></i> Registration
      </a>
      <a class="nav-link" href="#cards" onclick="switchTab('cards')">
        <i class="fas fa-id-card"></i> Cards
      </a>
      <a class="nav-link" href="#recharge" onclick="switchTab('recharge')">
        <i class="fas fa-credit-card"></i> Recharge
      </a>
      <a class="nav-link" href="#history" onclick="switchTab('history')">
        <i class="fas fa-history"></i> History
      </a>
      <a class="nav-link" href="#scan" onclick="switchTab('scan')">
        <i class="fas fa-qrcode"></i> Scan
      </a>
      <a class="nav-link" href="#profile" onclick="switchTab('profile')">
        <i class="fas fa-user"></i> Profile
      </a>
      <a class="nav-link" href="#reports" onclick="switchTab('reports')">
        <i class="fas fa-chart-bar"></i> Reports
      </a>
    </div>
  </header>

  <!-- Toast Container -->
  <div id="toastContainer"></div>


  <div class="content-wrapper">
    <div class="content-inner" id="content-container">
      <!-- Dynamic content rendered by JS -->
    </div>
  </div>


  <footer>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <a href="#" class="text-decoration-none me-2">Help</a>
        <a href="#" class="text-decoration-none me-2">Contact</a>
      </div>
      <small class="text-muted">Etra CITIZEN System &copy; 2024. All Rights Reserved.</small>
    </div>
  </footer>


  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
  </script>

  <script>

const LOCALSTORAGE_KEY = 'etraCitizenExtreme_v5';
let users = [];
let scans = [];
let recharges = [];
let logbook = [];
let refunds = []; // We store refund records separately for easy reporting


function loadDataFromLocalStorage() {
  try {
    const dStr = localStorage.getItem(LOCALSTORAGE_KEY);
    if (dStr) {
      const data = JSON.parse(dStr);
      if (data.users) users = data.users;
      if (data.scans) scans = data.scans;
      if (data.recharges) recharges = data.recharges;
      if (data.logbook) logbook = data.logbook;
      if (data.refunds) refunds = data.refunds;
    }
  } catch(e) {
    console.error('Error loading localStorage:', e);
  }
}
function saveDataToLocalStorage() {
  try {
    const data = {
      users,
      scans,
      recharges,
      logbook,
      refunds
    };
    localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(data));
  } catch(e) {
    console.error('Error saving localStorage:', e);
  }
}


function showAlert(type, title, text) {
  Swal.fire({
    icon: type,
    title,
    text,
    confirmButtonColor: (type==='error')?'#d33':'#3085d6'
  });
}

function showToast(message, title='Notification', color='bg-primary') {
  const toastId = 'toast-' + Date.now();
  const toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white ${color} border-0" 
         role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <strong>${title}:</strong> ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  const container = document.getElementById('toastContainer');
  container.insertAdjacentHTML('beforeend', toastHtml);
  const toastElem = document.getElementById(toastId);
  const bsToast = new bootstrap.Toast(toastElem, { delay: 3500 });
  bsToast.show();
}

function validateUserInput(fields) {
  for (let [key,val] of Object.entries(fields)) {
    if (!val && val!==false) { // allow false boolean
      showAlert('error','Validation Error',`${key} is required.`);
      return false;
    }
  }
  return true;
}

function validateExpirationDate(dateStr, isWhite) {
  const now = new Date();
  const exp = new Date(dateStr);
  const diff = (exp - now)/(1000*60*60*24);
  if (isWhite && diff>30) {
    showAlert('error','Invalid Exp','White card max 30 days from now.');
    return false;
  }
  if (!isWhite && diff<45) {
    showAlert('error','Invalid Exp','EID card requires â‰¥45 days.');
    return false;
  }
  return true;
}

function logAction(type, details) {
  logbook.push({
    timestamp: new Date().toLocaleString(),
    actionType: type,
    details
  });
  saveDataToLocalStorage();
}

function getUserBalance(uid) {
  const u = users.find(x=>x.id===uid);
  return (u) ? u.balance.toFixed(2) : '-';
}

function searchTable(tableId, searchId) {
  const input = document.getElementById(searchId);
  const filter = input.value.toLowerCase();
  const table = document.getElementById(tableId);
  const rows = table.getElementsByTagName("tr");
  for (let i=1; i<rows.length; i++){
    let show=false;
    const tds = rows[i].getElementsByTagName("td");
    for (let j=0; j<tds.length; j++){
      if (tds[j].innerText.toLowerCase().includes(filter)){
        show=true; break;
      }
    }
    rows[i].style.display = show?'':'none';
  }
}

function setDefaultExpiration() {
  const cType = document.getElementById("cardType");
  const expElem = document.getElementById("idExpiration");
  if (!cType || !expElem) return;
  const offset = (cType.value==='white')?30:45;
  const dt = new Date();
  dt.setDate(dt.getDate()+offset);
  expElem.value = dt.toISOString().split('T')[0];
}


loadDataFromLocalStorage();


let visibleCards = ['totalUsers','totalBalance'];
function swapCard(cardKey) {
  const allCards = ['totalUsers','totalBalance','expiring','lowBalance'];
  const hiddenSet = allCards.filter(x=> !visibleCards.includes(x));
  const idx = visibleCards.indexOf(cardKey);
  if (idx<0) return;
  visibleCards.splice(idx,1);
  const newCard = hiddenSet[0];
  visibleCards.push(newCard);
  tabs.home();
}

/*******************************************************************
 * 5. TAB NAVIGATION
 *******************************************************************/
function switchTab(tabId) {
  document.querySelectorAll('.header-right .nav-link').forEach(link=>{
    const href=link.getAttribute('href')||'';
    const linkTab = href.replace('#','');
    if (linkTab===tabId) link.classList.add('active');
    else link.classList.remove('active');
  });
  if (tabs[tabId]) tabs[tabId]();
}

function renderContent(html) {
  const container = document.getElementById("content-container");
  container.innerHTML = html;
}


const tabs = {
  home: () => {
    // Stats
    const totalUsers = users.length;
    const totalBal = users.reduce((acc,u)=>acc+u.balance,0).toFixed(2);
    const expiringCount = users.filter(u=>{
      const d = new Date(u.idExpiration);
      const limit=new Date(); limit.setDate(limit.getDate()+45);
      return d<limit;
    }).length;
    const lowBalCount = users.filter(u=>u.balance<10).length;

    // Additional fields for charts
    const whiteCount = users.filter(u=>u.remarks==='White Card').length;
    const eidCount   = users.filter(u=>u.remarks==='EID Card').length;

    const activeCount = users.filter(u=>u.status==='Active').length;
    const blockedCount = users.filter(u=>u.status==='Blocked').length;
    const frozenCount = users.filter(u=>u.status==='Frozen').length;

    // We'll have 'visibleCards' with keys => build them
    const cardData = {
      totalUsers: {
        title: 'Total Users',
        value: totalUsers,
        gradient: 'gradient1',
        icon: 'fa-users'
      },
      totalBalance: {
        title: 'Total Balance (days)',
        value: totalBal,
        gradient: 'gradient2',
        icon: 'fa-wallet'
      },
      expiring: {
        title: 'Expiring (â‰¤45d)',
        value: expiringCount,
        gradient: 'gradient3',
        icon: 'fa-clock'
      },
      lowBalance: {
        title: 'Low Balance (<10)',
        value: lowBalCount,
        gradient: 'gradient4',
        icon: 'fa-exclamation-triangle'
      }
    };
    let cardsHtml='';
    visibleCards.forEach(key=>{
      let c=cardData[key];
      cardsHtml+=`
        <div class="insight-card ${c.gradient}" onclick="swapCard('${key}')">
          <div>
            <div class="insight-title">${c.title}</div>
            <div class="insight-value">${c.value}</div>
          </div>
          <i class="fas ${c.icon} fa-4x" style="opacity:0.15; position:absolute; bottom:10px; right:10px;"></i>
        </div>
      `;
    });

    let homeHtml=`
      <div class="insights-container">
        ${cardsHtml}
      </div>
      <div class="charts-section">
        <div class="chart-card">
          <div class="chart-title">Card Type Distribution</div>
          <canvas id="cardTypeChart" width="400" height="220"></canvas>
          <div id="cardTypePlaceholder" class="chart-placeholder" style="display:none;">No data available.</div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Status Distribution (Active / Blocked / Frozen)</div>
          <canvas id="statusChart" width="400" height="220"></canvas>
          <div id="statusPlaceholder" class="chart-placeholder" style="display:none;">No data available.</div>
        </div>
      </div>
    `;
    renderContent(homeHtml);

    // Chart Type
    const ctc = document.getElementById('cardTypeChart');
    const hasAnyCard = (whiteCount+eidCount)>0;
    if (hasAnyCard) {
      new Chart(ctc, {
        type: 'doughnut',
        data:{
          labels:['EID','White'],
          datasets:[{
            data:[eidCount, whiteCount],
            backgroundColor:['#3498db','#f1c40f']
          }]
        },
        options:{ maintainAspectRatio:false }
      });
    } else {
      document.getElementById('cardTypePlaceholder').style.display='block';
      ctc.style.display='none';
    }

    // Status Chart
    const sc = document.getElementById('statusChart');
    const hasAnyStatus=(activeCount+blockedCount+frozenCount)>0;
    if (hasAnyStatus){
      new Chart(sc, {
        type:'pie',
        data:{
          labels:['Active','Blocked','Frozen'],
          datasets:[{
            data:[activeCount,blockedCount,frozenCount],
            backgroundColor:['#2ecc71','#e74c3c','#e056fd']
          }]
        },
        options:{ maintainAspectRatio:false }
      });
    } else {
      document.getElementById('statusPlaceholder').style.display='block';
      sc.style.display='none';
    }
  },

  registration: () => {
    let html=`
      <h2><i class="fas fa-user-plus me-2"></i>User Registration</h2>
      <form onsubmit="registerUser(event)">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">User ID</label>
            <input type="text" class="form-control" id="userId" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Emirates ID No.</label>
            <input type="text" class="form-control" id="emiratesIdNo" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Card Type</label>
            <select class="form-select" id="cardType" required onchange="toggleExpirationDate()">
              <option value="eid" selected>EID Card</option>
              <option value="white">White Card</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Expiration Date</label>
            <input type="date" class="form-control" id="idExpiration" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Remarks</label>
            <textarea class="form-control" id="remarks" rows="2"></textarea>
          </div>
          <!-- Additional fields as example -->
          <div class="col-md-6">
            <label class="form-label">Company Name</label>
            <input type="text" class="form-control" id="companyName"/>
          </div>
          <div class="col-md-6">
            <label class="form-label">Store Name</label>
            <input type="text" class="form-control" id="storeName"/>
          </div>
          <div class="col-md-6">
            <label class="form-label">Pick Location</label>
            <input type="text" class="form-control" id="pickLocation"/>
          </div>
          <div class="col-md-6">
            <label class="form-label">Online Company</label>
            <input type="checkbox" class="form-check-input ms-2" id="onlineCompany"/>
          </div>
          <div class="col-md-12">
            <label class="form-label">Block Card</label>
            <input type="checkbox" class="form-check-input ms-2" id="blockCard"/>
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-save me-1"></i>Register
          </button>
          <button type="reset" class="btn btn-secondary">
            <i class="fas fa-undo me-1"></i>Clear
          </button>
        </div>
      </form>
    `;
    renderContent(html);
    setDefaultExpiration();
  },

  cards: () => {
    // We'll show "Active", "Blocked", "Frozen"
    const activeRows = users.filter(u=>u.status==='Active').map(u=>`
      <tr>
        <td>${u.id}</td>
        <td>${u.name}</td>
        <td>${u.emiratesIdNo||'-'}</td>
        <td>${u.idExpiration}</td>
        <td>${u.status}</td>
        <td>
          <button class="btn btn-sm btn-danger me-1" onclick="blockCard('${u.id}')">Block</button>
          <button class="btn btn-sm btn-warning me-1" onclick="freezeCard('${u.id}')">
            <i class="fas fa-snowflake"></i>
          </button>
          <button class="btn btn-sm btn-info" onclick="viewHistory('${u.id}')">
            <i class="fas fa-history"></i>
          </button>
        </td>
      </tr>
    `).join('');

    const blockedRows = users.filter(u=>u.status==='Blocked').map(u=>`
      <tr>
        <td>${u.id}</td>
        <td>${u.name}</td>
        <td>${u.emiratesIdNo||'-'}</td>
        <td>${u.idExpiration}</td>
        <td>${u.status}</td>
        <td>
          <button class="btn btn-sm btn-success me-1" onclick="unblockCard('${u.id}')">Unblock</button>
          <button class="btn btn-sm btn-info" onclick="viewHistory('${u.id}')">
            <i class="fas fa-history"></i>
          </button>
          <button class="btn btn-sm btn-secondary" onclick="refundCard('${u.id}')">
            Refund
          </button>
        </td>
      </tr>
    `).join('');

    const frozenRows = users.filter(u=>u.status==='Frozen').map(u=>`
      <tr>
        <td>${u.id}</td>
        <td>${u.name}</td>
        <td>${u.emiratesIdNo||'-'}</td>
        <td>${u.idExpiration}</td>
        <td>${u.status}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="unfreezeCard('${u.id}')">
            <i class="fas fa-undo"></i>
          </button>
          <button class="btn btn-sm btn-info" onclick="viewHistory('${u.id}')">
            <i class="fas fa-history"></i>
          </button>
        </td>
      </tr>
    `).join('');

    let html=`
      <h2><i class="fas fa-id-card me-2"></i>Card Management</h2>
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#activeTab">Active Cards</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#blockedTab">Blocked Cards</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#frozenTab">Frozen Cards</button>
        </li>
      </ul>
      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="activeTab">
          <input type="text" id="searchActive" class="form-control mb-2" placeholder="Search Active" onkeyup="searchTable('activeTable','searchActive')" />
          <div class="table-container">
            <table class="table table-striped" id="activeTable">
              <thead>
                <tr><th>User ID</th><th>Name</th><th>Emirates ID</th><th>Expiration</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                ${activeRows}
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="blockedTab">
          <input type="text" id="searchBlocked" class="form-control mb-2" placeholder="Search Blocked" onkeyup="searchTable('blockedTable','searchBlocked')" />
          <div class="table-container">
            <table class="table table-striped" id="blockedTable">
              <thead>
                <tr><th>User ID</th><th>Name</th><th>Emirates ID</th><th>Expiration</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                ${blockedRows}
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="frozenTab">
          <input type="text" id="searchFrozen" class="form-control mb-2" placeholder="Search Frozen" onkeyup="searchTable('frozenTable','searchFrozen')" />
          <div class="table-container">
            <table class="table table-striped" id="frozenTable">
              <thead>
                <tr><th>User ID</th><th>Name</th><th>Emirates ID</th><th>Expiration</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                ${frozenRows}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    renderContent(html);
  },

  recharge: () => {
    let html=`
      <h2><i class="fas fa-credit-card me-2"></i>Recharge</h2>
      <form onsubmit="rechargeUser(event)">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">User ID</label>
            <input type="text" class="form-control" id="rechargeUserId" required onblur="autoFillRechargeInfo()" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="rechargeUserName" readonly />
          </div>
          <div class="col-md-4">
            <label class="form-label">Emirates ID</label>
            <input type="text" class="form-control" id="rechargeEmiratesId" readonly />
          </div>
          <div class="col-md-4">
            <label class="form-label">No. of Days Remaining</label>
            <input type="text" class="form-control" id="rechargeDaysRemaining" readonly />
          </div>
          <div class="col-md-4">
            <label class="form-label">Date (Recharge Date)</label>
            <input type="date" class="form-control" id="rechargeDate" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Payment Made</label>
            <select class="form-select" id="paymentMethod" required>
              <option value="online">Online Payment</option>
              <option value="debit">Debit</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Recharge Option</label>
            <select class="form-select" id="rechargeOption" required>
              <option value="10">10 Days - AED 50</option>
              <option value="15">15 Days - AED 75</option>
              <option value="30">30 Days + 5 Grace - AED 125</option>
              <option value="daily">Daily Pass - AED 10</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Remarks</label>
            <textarea class="form-control" id="rechargeRemarks" rows="2"></textarea>
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-credit-card me-1"></i>Recharge
          </button>
          <button type="reset" class="btn btn-secondary">
            <i class="fas fa-undo me-1"></i>Clear
          </button>
        </div>
      </form>
      <hr class="my-4" />
      <h4>Recent Recharges</h4>
      <div class="table-container">
        <table class="table table-striped">
          <thead>
            <tr><th>User ID</th><th>Date & Time</th><th>Option</th><th>Amount</th><th>Payment</th><th>Remarks</th></tr>
          </thead>
          <tbody>
            ${
              recharges.slice(-5).reverse().map(r=>`
                <tr>
                  <td>${r.userId}</td>
                  <td>${r.date}</td>
                  <td>${r.option}</td>
                  <td>AED ${r.amount}</td>
                  <td>${r.method}</td>
                  <td>${r.remarks||'-'}</td>
                </tr>
              `).join('')
            }
          </tbody>
        </table>
      </div>
    `;
    renderContent(html);
  },

  history: () => {
    let histHtml=`
      <h2><i class="fas fa-history me-2"></i>History</h2>
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#travelHistTab">Travel History</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#rechargeHistTab">Recharge History</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#incidentTab">Incidents</button>
        </li>
      </ul>
      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="travelHistTab">
          <input type="text" id="searchTravel" class="form-control mb-2" placeholder="Search Travel" onkeyup="searchTable('travelHistoryTable','searchTravel')" />
          <div class="table-container">
            <table class="table table-striped" id="travelHistoryTable">
              <thead><tr><th>User ID</th><th>In Time</th><th>Date</th><th>Bus No.</th><th>Remaining</th></tr></thead>
              <tbody>
                ${
                  scans.map(s=>`
                    <tr>
                      <td>${s.userId}</td>
                      <td>${s.inTime||'-'}</td>
                      <td>${s.dateStr||'-'}</td>
                      <td>${s.busNo||'Citizen 1'}</td>
                      <td>${getUserBalance(s.userId)}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="rechargeHistTab">
          <input type="text" id="searchRechargeHist" class="form-control mb-2" placeholder="Search Recharge" onkeyup="searchTable('rechargeHistoryTable','searchRechargeHist')" />
          <div class="table-container">
            <table class="table table-striped" id="rechargeHistoryTable">
              <thead><tr><th>User ID</th><th>Date & Time</th><th>Option</th><th>Amount</th><th>Payment</th><th>Tx ID</th></tr></thead>
              <tbody>
                ${
                  recharges.map((r,i)=>`
                    <tr>
                      <td>${r.userId}</td>
                      <td>${r.date}</td>
                      <td>${r.option}</td>
                      <td>AED ${r.amount}</td>
                      <td>${r.method}</td>
                      <td>TX${1000+i}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="incidentTab">
          <input type="text" id="searchIncident" class="form-control mb-2" placeholder="Search Incidents" onkeyup="searchTable('incidentTable','searchIncident')" />
          <div class="table-container">
            <table class="table table-striped" id="incidentTable">
              <thead><tr><th>User ID</th><th>Type</th><th>Timestamp</th><th>Action</th></tr></thead>
              <tbody>
                ${
                  logbook.filter(l=>l.actionType==='Incident').map(l=>`
                    <tr>
                      <td>${l.details.userId||'-'}</td>
                      <td>${l.details.type||'-'}</td>
                      <td>${l.timestamp}</td>
                      <td>${l.details.action||'-'}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    renderContent(histHtml);
  },

  scan: () => {
    const last = scans.slice(-5).reverse().map(s=>`
      <tr>
        <td>${s.userId}</td>
        <td>${s.inTime||'-'}</td>
        <td>${s.dateStr||'-'}</td>
        <td>${s.busNo||'Citizen 1'}</td>
        <td>${getUserBalance(s.userId)}</td>
      </tr>
    `).join('');
    let html=`
      <h2><i class="fas fa-qrcode me-2"></i>Scan</h2>
      <form onsubmit="scanCard(event)">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Scan Method</label>
            <select class="form-select" id="scanMethod" required>
              <option value="manual">Manual</option>
              <option value="qr">QR Code</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">User ID</label>
            <input type="text" class="form-control" id="scanUserId" required />
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-qrcode me-1"></i>Scan
          </button>
          <button type="reset" class="btn btn-secondary">
            <i class="fas fa-undo me-1"></i>Clear
          </button>
        </div>
      </form>
      <hr class="my-4" />
      <h4>Recent Scans</h4>
      <div class="table-container">
        <table class="table table-striped">
          <thead><tr><th>User ID</th><th>In Time</th><th>Date</th><th>Bus No.</th><th>Balance</th></tr></thead>
          <tbody>
            ${last}
          </tbody>
        </table>
      </div>
    `;
    renderContent(html);
  },

  profile: () => {
    // Unique design for user profile
    let html=`
      <h2><i class="fas fa-user me-2"></i>Passenger Profile</h2>
      <div class="mb-3">
        <label class="form-label">Enter User ID</label>
        <input type="text" class="form-control w-25" id="profileUserId" placeholder="e.g. U123" />
      </div>
      <button class="btn btn-info mb-3" onclick="viewPassengerProfile()">
        <i class="fas fa-search me-1"></i>Search Profile
      </button>
      <div id="profileResult"></div>
    `;
    renderContent(html);
  },

  reports: () => {
    let html=`
      <h2><i class="fas fa-chart-bar me-2"></i>Reports</h2>
      <form onsubmit="generateReport(event)">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Report Type</label>
            <select id="reportType" class="form-select" required>
              <option value="" disabled selected>Select...</option>
              <option value="financial">Financial Report</option>
              <option value="lowBalance">Low Balance</option>
              <option value="expiredCards">Expired Cards</option>
              <option value="whiteSummary">White Cards Summary</option>
              <option value="cashTransactions">Cash Transactions</option>
              <option value="cardTransactions">Card Transactions</option>
              <option value="refundReport">Refund Report</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" id="startDate" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" id="endDate" required />
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-filter me-1"></i>Generate
            </button>
          </div>
        </div>
      </form>
      <div id="reportResult" class="mt-4"></div>
    `;
    renderContent(html);
  }
};

/*******************************************************************
 * 7. EVENT HANDLERS
 *******************************************************************/
function registerUser(e) {
  e.preventDefault();
  const userId = document.getElementById("userId").value.trim();
  const fullName = document.getElementById("fullName").value.trim();
  const emiratesIdNo = document.getElementById("emiratesIdNo").value.trim();
  const cType = document.getElementById("cardType").value;
  const idExp = document.getElementById("idExpiration").value;
  const remarks = document.getElementById("remarks").value.trim();

  const companyName = document.getElementById("companyName").value.trim();
  const storeName = document.getElementById("storeName").value.trim();
  const pickLocation = document.getElementById("pickLocation").value.trim();
  const onlineCompany = document.getElementById("onlineCompany").checked;
  const blockCard = document.getElementById("blockCard").checked;

  // check duplicates
  if (users.find(u=>u.id===userId)) {
    showAlert('error','Registration Error','User ID already exists.');
    return;
  }
  // validate input
  if (!validateUserInput({userId, fullName, idExp})) return;
  let isWhite = (cType==='white');
  if (!validateExpirationDate(idExp, isWhite)) return;

  let statusVal='Active';
  if(blockCard) statusVal='Blocked';

  const userObj={
    id:userId,
    name:fullName,
    emiratesIdNo,
    cardType:isWhite?'White Card':'EID Card',
    idExpiration:idExp,
    balance:0,
    remarks:isWhite?'White Card':'EID Card',
    status:statusVal,
    issueDate:isWhite?(new Date().toISOString().split('T')[0]):null,
    companyName,
    storeName,
    pickLocation,
    onlineCompany
  };
  users.push(userObj);
  saveDataToLocalStorage();
  logAction('User Registered', userObj);
  showAlert('success','Success','User Registered.');
  showToast(`User [${userId}] added.`, 'Registration','bg-success');
  switchTab('cards');
}

function blockCard(userId) {
  const user=users.find(u=>u.id===userId);
  if(!user) {
    showAlert('error','Block Error','User not found');
    return;
  }
  if(user.status==='Blocked') {
    showAlert('info','Already Blocked',`[${userId}] is already blocked`);
    return;
  }
  user.status='Blocked';
  saveDataToLocalStorage();
  logAction('Card Blocked',{userId});
  showToast(`Card [${userId}] blocked.`, 'Block','bg-danger');
  switchTab('cards');
}

function unblockCard(userId) {
  const user=users.find(u=>u.id===userId);
  if(!user) {
    showAlert('error','Unblock Error','User not found');
    return;
  }
  if(user.status!=='Blocked') {
    showAlert('info','Not Blocked',`[${userId}] not blocked`);
    return;
  }
  user.status='Active';
  saveDataToLocalStorage();
  logAction('Card Unblocked',{userId});
  showToast(`Card [${userId}] unblocked.`, 'Unblock','bg-success');
  switchTab('cards');
}

function freezeCard(userId) {
  const user=users.find(u=>u.id===userId);
  if(!user){
    showAlert('error','Freeze Error','User not found.');
    return;
  }
  if(user.status==='Frozen') {
    showAlert('info','Already Frozen',`[${userId}] is already frozen.`);
    return;
  }
  user.status='Frozen';
  saveDataToLocalStorage();
  logAction('Card Frozen',{userId});
  showToast(`Card [${userId}] frozen.`, 'Freeze','bg-warning');
  switchTab('cards');
}

function unfreezeCard(userId) {
  const user=users.find(u=>u.id===userId);
  if(!user){
    showAlert('error','Unfreeze Error','User not found.');
    return;
  }
  if(user.status!=='Frozen') {
    showAlert('info','Not Frozen',`[${userId}] is not frozen`);
    return;
  }
  user.status='Active';
  saveDataToLocalStorage();
  logAction('Card Unfrozen',{userId});
  showToast(`Card [${userId}] is active.`, 'Unfreeze','bg-success');
  switchTab('cards');
}

function refundCard(userId) {
  const user=users.find(u=>u.id===userId);
  if(!user){
    showAlert('error','Refund Error','User not found.');
    return;
  }
  Swal.fire({
    title:'Refund Confirmation',
    text:`Refund all balance from [${userId}]? Current Balance = ${user.balance.toFixed(2)} days`,
    icon:'warning',
    showCancelButton:true,
    confirmButtonText:'Yes, Refund',
    cancelButtonText:'Cancel'
  }).then(res=>{
    if(res.isConfirmed){
      const refundAmount = user.balance;
      user.balance=0;
      saveDataToLocalStorage();
      // Also store in refunds array
      const refObj={
        userId,
        amount:refundAmount,
        timestamp:new Date().toLocaleString()
      };
      refunds.push(refObj);
      saveDataToLocalStorage();
      logAction('Refund',{userId,amount:refundAmount});
      showToast(`User [${userId}] refunded ${refundAmount} days.`, 'Refund','bg-secondary');
      switchTab('cards');
    }
  });
}

function viewHistory(userId) {
  const userScans=scans.filter(s=>s.userId===userId).slice(-5).reverse();
  const userRech=recharges.filter(r=>r.userId===userId).slice(-5).reverse();

  const scanRows=userScans.map(s=>`
    <tr>
      <td>${s.inTime||'-'}</td>
      <td>${s.dateStr||'-'}</td>
      <td>${s.busNo||'Citizen 1'}</td>
    </tr>
  `).join('');
  const rechRows=userRech.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.option}</td>
      <td>AED ${r.amount}</td>
      <td>${r.method}</td>
      <td>${r.remarks||'-'}</td>
    </tr>
  `).join('');

  let html=`
    <h5>Scans (Last 5)</h5>
    <table class="table table-sm table-striped mb-3">
      <thead><tr><th>In Time</th><th>Date</th><th>Bus No.</th></tr></thead>
      <tbody>${scanRows||'<tr><td colspan="3">No scans</td></tr>'}</tbody>
    </table>
    <h5>Recharges (Last 5)</h5>
    <table class="table table-sm table-striped">
      <thead><tr><th>Date & Time</th><th>Option</th><th>Amount</th><th>Method</th><th>Remarks</th></tr></thead>
      <tbody>${rechRows||'<tr><td colspan="5">No recharges</td></tr>'}</tbody>
    </table>
  `;
  Swal.fire({
    title:`History [${userId}]`,
    html,
    width:700,
    confirmButtonText:'Close'
  });
}

function autoFillRechargeInfo() {
  const userId = document.getElementById("rechargeUserId").value.trim();
  const user=users.find(u=>u.id===userId);
  if(!user){
    document.getElementById("rechargeUserName").value='';
    document.getElementById("rechargeEmiratesId").value='';
    document.getElementById("rechargeDaysRemaining").value='';
    return;
  }
  document.getElementById("rechargeUserName").value=user.name;
  document.getElementById("rechargeEmiratesId").value=user.emiratesIdNo||'';
  document.getElementById("rechargeDaysRemaining").value=user.balance.toFixed(2);
}

function rechargeUser(e) {
  e.preventDefault();
  const userId=document.getElementById("rechargeUserId").value.trim();
  const userName=document.getElementById("rechargeUserName").value.trim();
  const eIdNo=document.getElementById("rechargeEmiratesId").value.trim();
  const rDaysRemain=document.getElementById("rechargeDaysRemaining").value.trim();
  const rechargeD=document.getElementById("rechargeDate").value;
  const payMethod=document.getElementById("paymentMethod").value;
  const rOpt=document.getElementById("rechargeOption").value;
  const remarks=document.getElementById("rechargeRemarks").value.trim();

  const user=users.find(u=>u.id===userId);
  if(!user){
    showAlert('error','Recharge Error','User not found');
    return;
  }

  // If blocked/frozen, no recharge
  if(user.status==='Blocked'){
    showAlert('error','Blocked Card','Cannot recharge a blocked card.');
    return;
  }
  if(user.status==='Frozen'){
    showAlert('error','Frozen Card','Cannot recharge a frozen card.');
    return;
  }

  let days=0, amt=0;
  if(rOpt==='daily'){
    days=1; amt=10;
  } else {
    days=parseInt(rOpt);
    if(days===10) amt=50;
    else if(days===15) amt=75;
    else if(days===30) amt=125;
  }
  user.balance+=days;
  const rec={
    userId,
    date: new Date().toLocaleString(),
    rechargeDate: rechargeD,
    option:(rOpt==='daily')?'Daily Pass':days+' Days',
    amount:amt,
    method:(payMethod==='online'?'Online Payment':'Debit'),
    remarks
  };
  recharges.push(rec);
  saveDataToLocalStorage();
  logAction('User Recharged', rec);
  showAlert('success','Recharge Done',`[${userId}] +${days} days`);
  showToast(`User [${userId}] recharged +${days} days.`, 'Recharge','bg-success');
  switchTab('history');
}

function scanCard(e) {
  e.preventDefault();
  const method = document.getElementById("scanMethod").value;
  const userId = document.getElementById("scanUserId").value.trim();
  const user=users.find(u=>u.id===userId);
  if(!user){
    showAlert('error','Scan Error',`User [${userId}] not found.`);
    logAction('Incident',{userId,type:'Unregistered Scan'});
    return;
  }
  // blocked/frozen check
  if(user.status==='Blocked'){
    showAlert('error','Blocked Card','Cannot scan a blocked card.');
    return;
  }
  if(user.status==='Frozen'){
    showAlert('error','Frozen Card','Cannot scan a frozen card.');
    return;
  }

  const todayStr=new Date().toDateString();
  const dayScans=scans.filter(s=>
    s.userId===userId && new Date(s.timestamp).toDateString()===todayStr
  );
  if(dayScans.length>=2){
    showAlert('error','Limit Reached',`[${userId}] daily limit=2`);
    logAction('Incident',{userId,type:'Scan Limit Reached',action:'OverrideNeeded'});
    return;
  }
  if(user.balance<0.5){
    showAlert('error','No Balance',`[${userId}] has <0.5 days left`);
    logAction('Incident',{userId,type:'Insufficient Balance'});
    return;
  }
  const exp=new Date(user.idExpiration);
  if(exp<new Date()){
    showAlert('error','Card Expired',`[${userId}] card expired`);
    logAction('Incident',{userId,type:'Expired Card'});
    return;
  } else {
    const diff=(exp-(new Date()))/(1000*60*60*24);
    if(diff<45 && user.remarks==='EID Card'){
      showAlert('warning','EID Expiring',`[${userId}] <45 days left`);
      logAction('Warning',{userId,issue:'EID Expiring Soon'});
    }
  }
  user.balance-=0.5;
  const scanRec={
    userId,
    timestamp:new Date().toLocaleString(),
    inTime:new Date().toLocaleTimeString(),
    dateStr:new Date().toLocaleDateString(),
    busNo:'Citizen 1'
  };
  scans.push(scanRec);
  saveDataToLocalStorage();
  logAction('Card Scanned', scanRec);
  showAlert('success','Scan OK',`[${userId}] scanned. Rem: ${user.balance.toFixed(2)}`);
  showToast(`Scan success [${userId}] -0.5 days`, 'Scan','bg-info');
  switchTab('history');
}

function viewPassengerProfile() {
  const pid=document.getElementById("profileUserId").value.trim();
  const user=users.find(u=>u.id===pid);
  const resDiv=document.getElementById("profileResult");
  if(!user){
    resDiv.innerHTML=`<div class="alert alert-danger">User [${pid}] not found</div>`;
    return;
  }
  const userScans=scans.filter(s=>s.userId===pid);
  const userRechs=recharges.filter(r=>r.userId===pid);

  const scansRows=userScans.map(s=>`
    <tr>
      <td>${s.inTime||'-'}</td>
      <td>${s.dateStr||'-'}</td>
      <td>${s.busNo||'Citizen 1'}</td>
    </tr>
  `).join('');
  const rechsRows=userRechs.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.option}</td>
      <td>AED ${r.amount}</td>
      <td>${r.method}</td>
      <td>${r.remarks||'-'}</td>
    </tr>
  `).join('');

  // Enhanced UI for profile
  const html=`
    <div class="profile-card">
      <div class="profile-card-header">
        <h5 class="mb-0">Passenger: ${user.name} [${user.id}]</h5>
      </div>
      <div class="row">
        <div class="col-md-6">
          <p><strong>Emirates ID:</strong> ${user.emiratesIdNo||'-'}</p>
          <p><strong>Card Type:</strong> ${user.cardType}</p>
          <p><strong>Status:</strong> ${user.status}</p>
          <p><strong>Balance:</strong> ${user.balance.toFixed(2)}</p>
          <p><strong>Expiration:</strong> ${user.idExpiration}</p>
          ${user.issueDate?`<p><strong>Issue Date:</strong> ${user.issueDate}</p>`:''}
        </div>
        <div class="col-md-6">
          <p><strong>Company Name:</strong> ${user.companyName||'-'}</p>
          <p><strong>Store Name:</strong> ${user.storeName||'-'}</p>
          <p><strong>Pick Location:</strong> ${user.pickLocation||'-'}</p>
          <p><strong>Online Company:</strong> ${user.onlineCompany?'Yes':'No'}</p>
          <p><strong>Remarks:</strong> ${user.remarks||'-'}</p>
        </div>
      </div>
      <hr/>
      <button class="btn btn-secondary mb-2" data-bs-toggle="collapse" data-bs-target="#fullProfileHist">
        <i class="fas fa-eye me-1"></i>Show Full History
      </button>
      <div class="collapse" id="fullProfileHist">
        <h5>Scans</h5>
        <div class="table-container">
          <table class="table table-striped mb-3">
            <thead><tr><th>In Time</th><th>Date</th><th>Bus No.</th></tr></thead>
            <tbody>${scansRows||'<tr><td colspan="3">No scans</td></tr>'}</tbody>
          </table>
        </div>
        <h5>Recharges</h5>
        <div class="table-container">
          <table class="table table-striped">
            <thead><tr><th>Date & Time</th><th>Option</th><th>Amount</th><th>Method</th><th>Remarks</th></tr></thead>
            <tbody>${rechsRows||'<tr><td colspan="5">No recharges</td></tr>'}</tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  resDiv.innerHTML=html;
}

function generateReport(e) {
  e.preventDefault();
  const rType=document.getElementById("reportType").value;
  const sDate=new Date(document.getElementById("startDate").value);
  const eDate=new Date(document.getElementById("endDate").value);
  if(sDate>eDate){
    showAlert('error','Invalid Range','Start must be <= End');
    return;
  }
  let out='', filtered=[];
  switch(rType){
    case 'financial':
      {
        const pass=prompt('Enter passkey for financial(cash) report:');
        if(pass!=='4613'){
          showAlert('error','Denied','Wrong passkey');
          return;
        }
        // We'll interpret "online" as "cash" for demonstration or adapt logic
        filtered=recharges.filter(r=>{
          const dt=new Date(r.date);
          return dt>=sDate && dt<=eDate && r.method==='Online Payment';
        });
        out=`
          <h4>Financial (Online Payment) Report</h4>
          <div class="table-container">
            <table class="table table-striped">
              <thead><tr><th>User ID</th><th>Date & Time</th><th>Amount</th></tr></thead>
              <tbody>
                ${
                  filtered.map(r=>`
                    <tr>
                      <td>${r.userId}</td>
                      <td>${r.date}</td>
                      <td>AED ${r.amount}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        `;
      }
      break;
    case 'lowBalance':
      {
        filtered=users.filter(u=>u.balance<10);
        out=`
          <h4>Low Balance (<10)</h4>
          <div class="table-container">
            <table class="table table-striped">
              <thead><tr><th>User ID</th><th>Name</th><th>Balance</th></tr></thead>
              <tbody>
                ${
                  filtered.map(u=>`
                    <tr>
                      <td>${u.id}</td>
                      <td>${u.name}</td>
                      <td>${u.balance.toFixed(2)}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        `;
      }
      break;
    case 'expiredCards':
      {
        filtered=users.filter(u=>new Date(u.idExpiration)<new Date());
        out=`
          <h4>Expired Cards</h4>
          <div class="table-container">
            <table class="table table-striped">
              <thead><tr><th>User ID</th><th>Name</th><th>Expiration</th></tr></thead>
              <tbody>
                ${
                  filtered.map(u=>`
                    <tr>
                      <td>${u.id}</td>
                      <td>${u.name}</td>
                      <td>${u.idExpiration}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        `;
      }
      break;
    case 'whiteSummary':
      {
        filtered=users.filter(u=>u.remarks==='White Card');
        out=`
          <h4>White Cards Summary</h4>
          <div class="table-container">
            <table class="table table-striped">
              <thead><tr><th>User ID</th><th>Name</th><th>Issue Date</th><th>Expiration</th></tr></thead>
              <tbody>
                ${
                  filtered.map(u=>`
                    <tr>
                      <td>${u.id}</td>
                      <td>${u.name}</td>
                      <td>${u.issueDate||'-'}</td>
                      <td>${u.idExpiration}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        `;
      }
      break;
    case 'cashTransactions':
      {
        const pass=prompt('Enter passkey for cash transactions:');
        if(pass!=='4613'){
          showAlert('error','Denied','Wrong passkey');
          return;
        }
        // interpret "debit" as "cash" for example
        filtered=recharges.filter(r=>{
          const dt=new Date(r.date);
          return dt>=sDate && dt<=eDate && r.method==='Debit';
        });
        out=`
          <h4>Cash Transactions (treated as "Debit")</h4>
          <div class="table-container">
            <table class="table table-striped">
              <thead><tr><th>Tx ID</th><th>User</th><th>Date & Time</th><th>Amount</th></tr></thead>
              <tbody>
                ${
                  filtered.map((r,i)=>`
                    <tr>
                      <td>TX${1000+i}</td>
                      <td>${r.userId}</td>
                      <td>${r.date}</td>
                      <td>AED ${r.amount}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        `;
      }
      break;
    case 'cardTransactions':
      {
        filtered=scans.filter(s=>{
          const dt=new Date(s.timestamp);
          return dt>=sDate && dt<=eDate;
        });
        out=`
          <h4>Card Transactions (Scans)</h4>
          <div class="table-container">
            <table class="table table-striped">
              <thead><tr><th>User ID</th><th>Timestamp</th><th>In Time</th><th>Date</th><th>Bus No.</th></tr></thead>
              <tbody>
                ${
                  filtered.map(s=>`
                    <tr>
                      <td>${s.userId}</td>
                      <td>${s.timestamp}</td>
                      <td>${s.inTime||'-'}</td>
                      <td>${s.dateStr||'-'}</td>
                      <td>${s.busNo||'Citizen 1'}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        `;
      }
      break;
    case 'refundReport':
      {
        // show all refunds in date range
        const refFiltered=refunds.filter(r=>{
          const dt=new Date(r.timestamp);
          return dt>=sDate && dt<=eDate;
        });
        out=`
          <h4>Refund Report</h4>
          <div class="table-container">
            <table class="table table-striped">
              <thead><tr><th>User ID</th><th>Refund Amount</th><th>Date & Time</th></tr></thead>
              <tbody>
                ${
                  refFiltered.map((ref,i)=>`
                    <tr>
                      <td>${ref.userId}</td>
                      <td>${ref.amount.toFixed(2)} days</td>
                      <td>${ref.timestamp}</td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
          </div>
        `;
      }
      break;
    default:
      out='<p>No valid report selected.</p>';
  }
  document.getElementById("reportResult").innerHTML=out;
}


document.addEventListener("DOMContentLoaded", ()=>{
  switchTab('home');
});



</script>
</body>
</html>
